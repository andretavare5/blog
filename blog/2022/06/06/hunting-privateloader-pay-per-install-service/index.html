<!doctype html><html lang=en-us><head><title>Hunting PrivateLoader: Pay-Per-Install Service | André Tavares</title><meta charset=utf-8><meta name=language content="en"><meta name=description content="Detection and IOCs extraction"><meta name=keywords content="privateloader ,malware ,loader ,reversing ,yara ,hunting ,windows ,x86"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=twitter:card content="summary"><meta name=twitter:title content="Hunting PrivateLoader: Pay-Per-Install Service"><meta name=twitter:description content="Detection and IOCs extraction"><meta name=twitter:site content="@andretavare5"><meta name=twitter:creator content="https://twitter.com/andretavare5"><link rel="shortcut icon" type=image/png href=/favicon.ico><link type=text/css rel=stylesheet href=/css/post.min.86d1effd4c412b85ac13db53a90c473a0f256f789b821e131125c9aa25cb6a6d.css integrity="sha256-htHv/UxBK4WsE9tTqQxHOg8lb3ibgh4TESXJqiXLam0="><link type=text/css rel=stylesheet href=/css/custom.min.aadf40c0119f534df23c479d6f0f36bfa04cea49567477cea52e13ec08ae4d5a.css integrity="sha256-qt9AwBGfU03yPEedbw82v6BM6klWdHfOpS4T7AiuTVo="><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/tavares.re\/"},"articleSection":"blog","name":"Hunting PrivateLoader: Pay-Per-Install Service","headline":"Hunting PrivateLoader: Pay-Per-Install Service","description":"Detection and IOCs extraction","inLanguage":"en-US","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"2022","datePublished":"2022-06-06 00:00:00 \u002b0000 UTC","dateModified":"2022-06-06 00:00:00 \u002b0000 UTC","url":"https:\/\/tavares.re\/blog\/2022\/06\/06\/hunting-privateloader-pay-per-install-service\/","wordCount":"752","keywords":["privateloader","malware","loader","reversing","yara","hunting","windows","x86","Blog"]}</script></head><body><div class=burger__container><div class=burger aria-controls=navigation aria-label=Menu><div class="burger__meat burger__meat--1"></div><div class="burger__meat burger__meat--2"></div><div class="burger__meat burger__meat--3"></div></div></div><nav class=nav id=navigation><ul class=nav__list><li><a href=/about>about</a></li><li><a class=active href=/blog>blog</a></li><li><a href=/>home</a></li></ul></nav><main><div class=flex-wrapper><div class=post__container><div class=post><header class=post__header><h1 id=post__title>Hunting PrivateLoader: Pay-Per-Install Service</h1><time datetime="2022-06-06 00:00:00 +0000 UTC" class=post__date>Jun 6 2022</time></header><article class=post__content><br><figure><a href=https://unsplash.com/photos/f1SLpsPGODo><img src=/blog/2022/06/06/andreas-brun-f1SLpsPGODo-unsplash.jpg alt="Cat hunting"></a></figure><p>PrivateLoader is a downloader, <a href=https://intel471.com/blog/privateloader-malware target=_blank rel="noreferrer noopener">first seen on early 2021</a>. It&rsquo;s part of a pay-per-install (PPI) malware distribution service available on underground forums and so it&rsquo;s used by multiple threat actors to distribute ransomware, information stealers, banking trojans, downloaders, and other commodity malware on windows machines. The malware payloads are selectively delivered to victims based on certain criteria such as location, financial activity, environment and specific software installed. It&rsquo;s delivered through websites that claim to provide cracked software.</p><p>Let&rsquo;s have a look at the malware and try to find a way to detect and hunt it.</p><p>Here&rsquo;s a sample analyzed by <a href=https://www.zscaler.com/blogs/security-research/peeking-privateloader target=_blank rel="noreferrer noopener">Zscaler</a> on April 2022:
<a href=https://tria.ge/220430-z8fbmaagb9 target=_blank rel="noreferrer noopener">aa2c0a9e34f9fa4cbf1780d757cc84f32a8bd005142012e91a6888167f80f4d5</a></p><p>Let&rsquo;s open it on <a href=https://ghidra-sre.org/ target=_blank rel="noreferrer noopener">Ghidra</a>. Going into the entry point, following the code, looking for interesting functions, I quickly spot the function at <code>0x406360</code>. It&rsquo;s calling <code>LoadLibraryA</code> but the <code>lpLibFileName</code> parameter is built dynamically at runtime using the stack. Its seems that we found a string obfuscation technique. Both the string and the xor key are loaded into the stack. Looking a bit more through the function, its seems that this is the way most of the strings are loaded:</p><br><figure><img src=/blog/2022/06/06/stack-xor-str.png></figure><p>After XOR the encrypted string with the key, we get <code>kernel32.dll</code>.</p><p>This uncommon string deobfuscation technique can be leveraged to build a <a href=https://github.com/VirusTotal/yara target=_blank rel="noreferrer noopener">Yara</a> rule for detection and hunting purposes. To reduce the number of false positives and increase the rule performance, we can add a plaintext unicode string <a href=https://www.zscaler.com/blogs/security-research/peeking-privateloader target=_blank rel="noreferrer noopener">used on the C2 communication</a> and a few minor conditions. Here&rsquo;s the rule:</p><br><script type=application/javascript src=https://gist.github.com/andretavare5/9d8eb659946ff509d9987c9be4031bb6.js></script><p>After running this rule on VirusTotal retro hunting, I got over 1.5k samples on a 1 year timeframe. By manually analyzing some of the matches, I couldn&rsquo;t find any false positives. As a first attempt of hunting and detecting PrivateLoader, this rule seems to yield good results.</p><p>Now, to faster analyze the malware and better understand its behavior, we should build a string deobfuscator to help us on our reversing efforts and better document the code. With the help of <a href=https://www.capstone-engine.org/ target=_blank rel="noreferrer noopener">Capstone</a> disassembly framework, and some trial and error, here&rsquo;s the script:</p><pre><code class=language-python>import pefile
from capstone import *

def search(instructions, offset):
  dwords = []
  for inst in instructions:
    if inst[2] == 'mov':
      try:
        dword = int(inst[3].split(' ')[-1], 16).to_bytes(4, 'little')
        dwords.append(dword)
      except:
        pass # not the mov we want
      if inst[3].split(', ')[0].split(' ')[-1] == offset:
        return b''.join(dwords[::-1][:4]) # 16 bytes str chunk      

# disassemble .txt section
pe = pefile.PE('aa2c0a9e34f9fa4cbf1780d757cc84f32a8bd005142012e91a6888167f80f4d5')
md = Cs(CS_ARCH_X86, CS_MODE_32)
instructions = []
for (address, size, mnemonic, op_str) in md.disasm_lite(pe.sections[0].get_data(), 0):
  instructions.append((address, size, mnemonic, op_str))

# search, build and deobfuscate strings
strings = []
addr = None
string = ''
for i, inst in enumerate(instructions):
  if inst[2] == 'pxor': 
    try: # possible string deobfuscation found
      key_offset = inst[3].split(' ')[-1]
      key = search(instructions[:i][::-1], key_offset)
      insts = instructions[:i][::-1] # from pxor up
      for j, inst in enumerate(insts):
        if inst[2] == 'movaps': 
          # encrypted string being moved to xmm1
          str_offset = inst[3].split(' ')[-1]
          encrypted_str = search(insts[j:], str_offset)
          # str chunk deobfuscation
          string += bytearray(key[i] ^ string[i] for i in range(len(key))).decode()
          break # next chuck
          
      if not addr:
        addr = hex(inst[0])
      if '\x00' in string: 
        strings.append((addr, string.replace('\x00', '')))
        string = '' 
        addr = None
      except:
        pass # not the pxor we want
</code></pre><p>After running it against the sample we are analyzing, we get the following strings:</p><pre><code>0x3ee GetCurrentProcess
0x469 CreateThread
0x4ba CreateFileA
0x506 Sleep
0x572 SetPriorityClass
0x5ec Shell32.dll
0x657 SHGetFolderPathA
0x83b null
0x1078 rb
0x157c http://212.193.30.45/proxies.txt
0x1795 :1080
0x1839 \n
0x1f2d :1080
0x1fd1 :
0x26ce .
0x28ac .
0x2972 .
0x2a34 .
0x32ad http://45.144.225.57/server.txt
0x33c0 HOST:
0x346e :
0x3760 pastebin.com/raw/A7dSG1teëä
0x38a3 HOST:
0x3965 HOST:
0x3b93 http://wfsdragon.ru/api/setStats.php
0x3dcd HOST:
0x3f84 :
0x40ae 2.56.59.42
0x4350 /base/api/statistics.php
0x4439 URL:
0x44b6 :
0x4a5e https://
0x4ad8 .tmp
0x4bf6 \
0x53e9 kernel32.dll
0x544a WINHTTP.dll
0x54a5 wininet.dll
0x65a8 WinHttpConnect
0x6682 WinHttpOpenRequest
0x671a WinHttpQueryDataAvailable
0x67b2 WinHttpSendRequest
0x684a WinHttpReceiveResponse
0x68e2 WinHttpQueryHeaders
0x6956 WinHttpOpen
0x69b5 WinHttpReadData
0x6a20 WinHttpCloseHandle
0x6b09 Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.63 Safari/537.36
0x7402 http://
0x74ab /
0x7582 ?
0x851a HEAD
0x8fa8 Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.63 Safari/537.36
0x91f0 wininet.dll
0x925b InternetSetOptionA
0x92ef HttpOpenRequestA
0x938d InternetConnectA
0x9421 InternetOpenUrlA
0x949e InternetOpenA
0x94f2 HttpQueryInfoA
0x9567 InternetQueryOptionA
0x95fb HttpSendRequestA
0x9694 InternetReadFile
0x9737 InternetCloseHandle
0x97ad Kernel32.dll
0x9801 HeapAlloc
0x9852 HeapFree
0x98a3 GetProcessHeap
0x98f3 CharNextA
0x9938 User32.dll
0x9994 GetLastError
0x99e5 CreateFileA
0x9a36 WriteFile
0x9a87 CloseHandle
</code></pre><p>We can now go back to Ghidra and continue our analysis, now with more context of what might be the malware&rsquo;s behavior.</p><p>As a bonus, we get some network IOCs that can be used for defense and tracking purposes:</p><pre><code>http://212.193.30.45/proxies.txt
http://45.144.225.57/server.txt
pastebin.com/raw/A7dSG1te
http://wfsdragon.ru/api/setStats.php
2.56.59.42
/base/api/statistics.php
</code></pre></article><ul class=tags__list><li class=tag__item><a class=tag__link href=https://tavares.re/tags/privateloader/>privateloader</a></li><li class=tag__item><a class=tag__link href=https://tavares.re/tags/malware/>malware</a></li><li class=tag__item><a class=tag__link href=https://tavares.re/tags/loader/>loader</a></li><li class=tag__item><a class=tag__link href=https://tavares.re/tags/reversing/>reversing</a></li><li class=tag__item><a class=tag__link href=https://tavares.re/tags/yara/>yara</a></li><li class=tag__item><a class=tag__link href=https://tavares.re/tags/hunting/>hunting</a></li><li class=tag__item><a class=tag__link href=https://tavares.re/tags/windows/>windows</a></li><li class=tag__item><a class=tag__link href=https://tavares.re/tags/x86/>x86</a></li></ul><div class=pagination><a class=pagination__item href=https://tavares.re/blog/2022/02/04/flubot-persists-infecting-europe-and-australia/><span class=pagination__label>Previous Post</span>
<span class=pagination__title>FluBot Persists: Infecting Europe and Australia</span></a></div><footer class=post__footer><div class=social-icons><a class=social-icons__link title=Twitter href=https://twitter.com/andretavare5 target=_blank rel="me noopener"><div class=social-icons__icon style=background-image:url(https://tavares.re/svg/twitter.svg)></div></a><a class=social-icons__link title=GitHub href=https://github.com/andretavare5 target=_blank rel="me noopener"><div class=social-icons__icon style=background-image:url(https://tavares.re/svg/github.svg)></div></a><a class=social-icons__link title=Email href=mailto:andretavare5@pm.me target=_blank rel="me noopener"><div class=social-icons__icon style=background-image:url(https://tavares.re/svg/email.svg)></div></a><a class=social-icons__link title=RSS href=/index.xml target=_blank rel="me noopener"><div class=social-icons__icon style=background-image:url(https://tavares.re/svg/rss.svg)></div></a></div><p>© 2022 André Tavares. Built with <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/jakewies/hugo-theme-codex>Codex</a></p></footer></div></div></div></main><script src=/js/index.min.301a8b0870381bf76b3b5182e8966d363a0474281183439beb024d8b8228fc66.js integrity="sha256-MBqLCHA4G/drO1GC6JZtNjoEdCgRg0Ob6wJNi4Io/GY=" crossorigin=anonymous></script>
<script src=https://unpkg.com/prismjs@1.20.0/components/prism-core.min.js></script>
<script src=https://unpkg.com/prismjs@1.20.0/plugins/autoloader/prism-autoloader.min.js data-autoloader-path=https://unpkg.com/prismjs@1.20.0/components/></script></body></html>