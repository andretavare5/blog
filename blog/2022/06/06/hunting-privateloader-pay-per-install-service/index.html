<!doctype html><html lang=en-us><head><title>Hunting PrivateLoader: Pay-Per-Install Service | André Tavares</title><meta charset=utf-8><meta name=language content="en"><meta name=description content="Detection and IOCs extraction"><meta name=keywords content="privateloader ,malware ,loader ,reversing ,yara ,windows"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=twitter:card content="summary"><meta name=twitter:title content="Hunting PrivateLoader: Pay-Per-Install Service"><meta name=twitter:description content="Detection and IOCs extraction"><meta name=twitter:site content="@andretavare5"><meta name=twitter:creator content="https://twitter.com/andretavare5"><link rel="shortcut icon" type=image/png href=/favicon.ico><link type=text/css rel=stylesheet href=/css/post.min.b3047d733d54654928c287e1e241909b9993300290abbb5297c8efe7dc0cc96a.css integrity="sha256-swR9cz1UZUkowofh4kGQm5mTMAKQq7tSl8jv59wMyWo="><link type=text/css rel=stylesheet href=/css/custom.min.aadf40c0119f534df23c479d6f0f36bfa04cea49567477cea52e13ec08ae4d5a.css integrity="sha256-qt9AwBGfU03yPEedbw82v6BM6klWdHfOpS4T7AiuTVo="><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/tavares.re\/"},"articleSection":"blog","name":"Hunting PrivateLoader: Pay-Per-Install Service","headline":"Hunting PrivateLoader: Pay-Per-Install Service","description":"Detection and IOCs extraction","inLanguage":"en-US","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"2022","datePublished":"2022-06-06 00:00:00 \u002b0000 UTC","dateModified":"2022-06-06 00:00:00 \u002b0000 UTC","url":"https:\/\/tavares.re\/blog\/2022\/06\/06\/hunting-privateloader-pay-per-install-service\/","wordCount":"564","keywords":["privateloader","malware","loader","reversing","yara","windows","Blog"]}</script></head><body><div class=burger__container><div class=burger aria-controls=navigation aria-label=Menu><div class="burger__meat burger__meat--1"></div><div class="burger__meat burger__meat--2"></div><div class="burger__meat burger__meat--3"></div></div></div><nav class=nav id=navigation><ul class=nav__list><li><a href=/>home</a></li><li><a href=/about>about</a></li><li><a class=active href=/blog>blog</a></li></ul></nav><main><div class=flex-wrapper><div class=post__container><div class=post><header class=post__header><h1 id=post__title>Hunting PrivateLoader: Pay-Per-Install Service</h1><time datetime="2022-06-06 00:00:00 +0000 UTC" class=post__date>Jun 6 2022</time></header><article class=post__content><br><figure><a href=https://unsplash.com/photos/f1SLpsPGODo><img src=/blog/2022/06/06/andreas-brun-f1SLpsPGODo-unsplash.webp alt="Cat hunting"></a></figure><p>PrivateLoader is a malware loader from a pay-per-install malware distribution service, that has been used to distribute info stealers, banking trojans, other loaders, and even ransomware, on machines running windows. <a href=https://intel471.com/blog/privateloader-malware target=_blank rel="noreferrer noopener">First seen in early 2021</a> being hosted on websites that claim to provide cracked software, the customers of the service are able to selectively deliver malware to victims based on location, financial activity, environment, and specific software installed.</p><p>Let&rsquo;s have a look at the malware and try to find a way to detect and hunt it.</p><h2 id=encrypted-stack-strings>Encrypted Stack Strings<a class=anchor href=#encrypted-stack-strings>#</a></h2><p>Here&rsquo;s a <a href=https://tria.ge/220430-z8fbmaagb9 target=_blank rel="noreferrer noopener">sample</a> analyzed by <a href=https://www.zscaler.com/blogs/security-research/peeking-privateloader target=_blank rel="noreferrer noopener">Zscaler</a> on April 2022:</p><pre><code>aa2c0a9e34f9fa4cbf1780d757cc84f32a8bd005142012e91a6888167f80f4d5
</code></pre><p>Let&rsquo;s open it on <a href=https://ghidra-sre.org/ target=_blank rel="noreferrer noopener">Ghidra</a>. Going into the entry point, following the code, looking for interesting functions, I quickly spot the function at <code>0x406360</code>. It&rsquo;s calling <code>LoadLibraryA</code> but the <code>lpLibFileName</code> parameter is built dynamically at runtime using the stack. Its seems that we found a string encryption technique. Both the string and the xor key are loaded into the stack. Looking a bit more through the function, its seems that this is the way most of the strings are loaded:</p><br><figure><img src=/blog/2022/06/06/privateloader-stack-xor-str.webp alt="privateloader stack xor str"></figure><p>After XOR the encrypted string with the key, we get <code>kernel32.dll</code>.</p><h2 id=detecting-the-malware>Detecting The Malware<a class=anchor href=#detecting-the-malware>#</a></h2><p>This uncommon string decryption technique can be leveraged to write a <a href=https://github.com/VirusTotal/yara target=_blank rel="noreferrer noopener">Yara</a> rule for detection and hunting purposes. To reduce the number of false positives and increase the rule performance, we can add a plaintext unicode string <a href=https://www.zscaler.com/blogs/security-research/peeking-privateloader target=_blank rel="noreferrer noopener">used on the C2 communication</a> and a few minor conditions. Here&rsquo;s the rule:</p><br><script type=application/javascript src=https://gist.github.com/andretavare5/9d8eb659946ff509d9987c9be4031bb6.js></script><p>After running this rule on VirusTotal retro hunting, I got over 1.7k samples on a 1 year timeframe. By manually analyzing some of the matches, I couldn&rsquo;t find any false positives. As a first attempt of hunting and detecting PrivateLoader, this rule seems to yield good results.</p><h2 id=decrypting-the-strings>Decrypting The Strings<a class=anchor href=#decrypting-the-strings>#</a></h2><p>Now, to faster analyze the malware and better understand its behavior, we should build a string decryptor to help us on our reversing efforts and better document the code. With the help of <a href=https://www.capstone-engine.org/ target=_blank rel="noreferrer noopener">Capstone</a> disassembly framework, and some trial and error, here&rsquo;s the script:</p><br><script type=application/javascript src=https://gist.github.com/andretavare5/66ec413cdb4c7c39d35c22d38c7067a8.js></script><p>After running it against the sample we are analyzing, we get the following strings:</p><pre><code>0x4003ee GetCurrentProcess
0x400469 CreateThread
0x4004ba CreateFileA
0x400506 Sleep
0x400572 SetPriorityClass
0x4005ec Shell32.dll
0x400657 SHGetFolderPathA
0x40083b null
0x401078 rb
0x40157c http://212.193.30.45/proxies.txt
0x401795 :1080
0x401839 \n
0x401f2d :1080
0x401fd1 :
0x4026ce .
0x4028ac .
0x402972 .
0x402a34 .
0x4032ad http://45.144.225.57/server.txt
0x4033c0 HOST:
0x40346e :
0x403760 pastebin.com/rawHOST:
0x403965 HOST:
0x403b93 http://wfsdragon.ru/api/setStats.php
0x403dcd HOST:
0x403f84 :
0x4040ae 2.56.59.42
0x404350 /base/api/statistics.php
0x404439 URL:
0x4044b6 :
0x404a5e https://
0x404ad8 .tmp
0x404bf6 \
0x4053e9 kernel32.dll
0x40544a WINHTTP.dll
0x4054a5 wininet.dll
0x406616 WinHttpConnect
0x406682 WinHttpOpenRequest
0x40671a WinHttpQueryDataAvailable
0x4067b2 WinHttpSendRequest
0x40684a WinHttpReceiveResponse
0x4068e2 WinHttpQueryHeaders
0x406956 WinHttpOpen
0x4069b5 WinHttpReadData
0x406a20 WinHttpCloseHandle
0x406b09 Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.63 Safari/537.36
0x407402 http://
0x4074ab /
0x407582 ?
0x40851a HEAD
0x408fa8 Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/93.0.4577.63 Safari/537.36
0x4091f0 wininet.dll
0x40925b InternetSetOptionA
0x4092ef HttpOpenRequestA
0x40938d InternetConnectA
0x409421 InternetOpenUrlA
0x40949e InternetOpenA
0x4094f2 HttpQueryInfoA
0x409567 InternetQueryOptionA
0x4095fb HttpSendRequestA
0x409694 InternetReadFile
0x409737 InternetCloseHandle
0x4097ad Kernel32.dll
0x409801 HeapAlloc
0x409852 HeapFree
0x4098a3 GetProcessHeap
0x4098f3 CharNextA
0x409938 User32.dll
0x409994 GetLastError
0x4099e5 CreateFileA
0x409a36 WriteFile
0x409a87 CloseHandle
</code></pre><p>We can now go back to Ghidra and continue our analysis, now with more context of what might be the malware&rsquo;s behavior.</p><h2 id=network-iocs>Network IOCs<a class=anchor href=#network-iocs>#</a></h2><p>As a bonus, we get some network IOCs that can be used for defense and tracking purposes:</p><pre><code>http://212.193.30.45/proxies.txt
http://45.144.225.57/server.txt
pastebin.com/raw/A7dSG1te
http://wfsdragon.ru/api/setStats.php
2.56.59.42
/base/api/statistics.php
</code></pre></article><ul class=tags__list><li class=tag__item><a class=tag__link href=https://tavares.re/tags/privateloader/>privateloader</a></li><li class=tag__item><a class=tag__link href=https://tavares.re/tags/malware/>malware</a></li><li class=tag__item><a class=tag__link href=https://tavares.re/tags/loader/>loader</a></li><li class=tag__item><a class=tag__link href=https://tavares.re/tags/reversing/>reversing</a></li><li class=tag__item><a class=tag__link href=https://tavares.re/tags/yara/>yara</a></li><li class=tag__item><a class=tag__link href=https://tavares.re/tags/windows/>windows</a></li></ul><div class=pagination><a class=pagination__item href=https://tavares.re/blog/2022/02/04/flubot-persists-infecting-europe-and-australia/><span class=pagination__label>Previous Post</span>
<span class=pagination__title>FluBot Persists: Infecting Europe and Australia</span></a></div><footer class=post__footer><div class=social-icons><a class=social-icons__link title=Twitter href=https://twitter.com/andretavare5 target=_blank rel="me noopener"><div class=social-icons__icon style=background-image:url(https://tavares.re/svg/twitter.svg)></div></a><a class=social-icons__link title=Email href=mailto:andretavare5@pm.me target=_blank rel="me noopener"><div class=social-icons__icon style=background-image:url(https://tavares.re/svg/email.svg)></div></a><a class=social-icons__link title=RSS href=/index.xml target=_blank rel="me noopener"><div class=social-icons__icon style=background-image:url(https://tavares.re/svg/rss.svg)></div></a></div><p>© 2022 André Tavares. Built with <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/jakewies/hugo-theme-codex>Codex</a></p></footer></div></div></div></main><script src=/js/index.min.301a8b0870381bf76b3b5182e8966d363a0474281183439beb024d8b8228fc66.js integrity="sha256-MBqLCHA4G/drO1GC6JZtNjoEdCgRg0Ob6wJNi4Io/GY=" crossorigin=anonymous></script>
<script src=https://unpkg.com/prismjs@1.20.0/components/prism-core.min.js></script>
<script src=https://unpkg.com/prismjs@1.20.0/plugins/autoloader/prism-autoloader.min.js data-autoloader-path=https://unpkg.com/prismjs@1.20.0/components/></script></body></html>